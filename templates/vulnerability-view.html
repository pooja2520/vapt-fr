{% extends "base.html" %}
{% block title %}Vulnerability Detail - VAPT Scanner Pro{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='css/vulnerabilities.css') }}">{% endblock %}
{% block body %}
<div id="_main" style="padding-top:56px;margin-left:220px;min-height:100vh;">
<div class="content" id="vContent">
  <a href="/vulnerabilities" class="back-a"><i class="fa-solid fa-arrow-left"></i> Back to Vulnerabilities</a>

  <!-- Loading state -->
  <div id="loadingState" style="text-align:center;padding:4rem;color:var(--text-muted);">
    <i class="fa-solid fa-spinner fa-spin" style="font-size:2rem;margin-bottom:1rem;display:block;color:var(--blue)"></i>
    Loading vulnerability details...
  </div>

  <!-- Error state -->
  <div id="errorState" style="display:none;text-align:center;padding:4rem;color:var(--text-muted);">
    <i class="fa-solid fa-circle-exclamation" style="font-size:2rem;margin-bottom:1rem;display:block;color:var(--red)"></i>
    <p>Vulnerability not found.</p>
    <a href="/vulnerabilities" class="btn btn-o" style="margin-top:1rem;display:inline-flex;">← Back to list</a>
  </div>

  <!-- Main content (hidden until loaded) -->
  <div id="mainContent" style="display:none;">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.625rem;">
      <div>
        <h1 id="vTitle" style="font-family:'Space Grotesk',sans-serif;font-size:1.375rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:.4rem;">
          <i class="fa-solid fa-bug" style="color:var(--orange)"></i> —
        </h1>
        <div style="display:flex;gap:.5rem;margin-top:.4rem;flex-wrap:wrap;" id="vBadges"></div>
      </div>
      <button class="btn btn-p" id="fixBtn" onclick="toggleFix()">
        <i class="fa-solid fa-circle-check"></i> Mark as Fixed
      </button>
    </div>

    <!-- Meta row -->
    <div class="meta-row" id="metaRow"></div>

    <!-- Scan Finding -->
    <div class="card">
      <div class="ch"><i class="fa-regular fa-file-lines"></i> Scan Finding</div>
      <div class="cb">
        <p id="vFinding" style="font-size:.875rem;color:var(--text);line-height:1.7">—</p>
      </div>
    </div>

    <!-- Affected Paths -->
    <div class="card" id="pathsCard" style="display:none;">
      <div class="ch"><i class="fa-solid fa-link"></i> Affected Path(s)</div>
      <div class="cb">
        <div id="vPaths" class="poc-block" style="font-size:.8rem;word-break:break-all;"></div>
      </div>
    </div>

    <!-- Remediation -->
    <div class="card" id="remCard" style="display:none;">
      <div class="ch"><i class="fa-solid fa-screwdriver-wrench"></i> Remediation</div>
      <div class="cb">
        <p id="vRemediation" style="font-size:.875rem;color:var(--text);line-height:1.7"></p>
      </div>
    </div>

    <!-- Resolution Steps -->
    <div class="card" id="stepsCard" style="display:none;">
      <div class="ch"><i class="fa-solid fa-list-check"></i> Resolution Steps</div>
      <div class="cb" id="vSteps"></div>
    </div>

    <!-- Raw info for debugging -->
    <div class="card">
      <div class="ch"><i class="fa-solid fa-circle-info"></i> Scan Details</div>
      <div class="cb">
        <table style="width:100%;font-size:.825rem;" id="detailTable"></table>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock %}
{% block scripts %}
<script>
initLayout('/vulnerabilities');

// Extract vuln id from URL: /vulnerabilities/5
const vulnId = parseInt(window.location.pathname.split('/').pop());
let currentVuln = null;
let isFixed = false;

async function loadVuln() {
    try {
        const res  = await fetch(`/api/vulnerabilities/${vulnId}`);
        const data = await res.json();

        if (data.status !== 'success' || !data.vulnerability) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            return;
        }

        currentVuln = data.vulnerability;
        isFixed     = !!currentVuln._fixed;
        renderVuln(currentVuln);

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display  = 'block';
    } catch (e) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display   = 'block';
    }
}

function severityClass(sev) {
    sev = (sev||'').toLowerCase();
    return sev==='critical'?'bc': sev==='high'?'bh': sev==='medium'?'bm': 'bl';
}
function statusClass(st) {
    st = (st||'').toLowerCase();
    return st==='vulnerable'?'bc': st==='fixed'?'bf': st==='complete'||st==='success'?'bac':'bop';
}

function renderVuln(v) {
    const sev        = v.Severity || 'Info';
    const dispStatus = v._display_status || v.Status || 'Unknown';
    const target     = v.target_url ? v.target_url.replace('https://','').replace('http://','').split('/')[0] : '—';
    const date       = v.scan_date || '—';

    // Title
    document.getElementById('vTitle').innerHTML =
        `<i class="fa-solid fa-bug" style="color:${sev.toLowerCase()==='critical'?'#ef4444':sev.toLowerCase()==='high'?'#f97316':'var(--orange)'}"></i> ${v.Test || '—'}`;

    // Badges
    document.getElementById('vBadges').innerHTML = `
        <span class="bx ${severityClass(sev)}"><i class="fa-solid fa-triangle-exclamation"></i> ${sev}</span>
        <span class="bx ${statusClass(dispStatus)}" id="statusBadge"><i class="fa-solid fa-circle-exclamation"></i> ${dispStatus}</span>`;

    // Fix button
    updateFixButton();

    // Meta row
    document.getElementById('metaRow').innerHTML = `
        <div class="mc"><small>Target</small><strong><i class="fa-solid fa-crosshairs" style="color:var(--blue)"></i> ${target}</strong></div>
        <div class="mc"><small>Scan Date</small><strong>${date}</strong></div>
        <div class="mc"><small>Severity</small><strong style="color:${sev.toLowerCase()==='critical'?'var(--red)':sev.toLowerCase()==='high'?'var(--orange)':'var(--yellow)'}">${sev}</strong></div>
        <div class="mc"><small>Status</small><strong id="metaStatus">${dispStatus}</strong></div>`;

    // Finding
    document.getElementById('vFinding').textContent = v.Finding || 'No finding details available.';

    // Affected paths
    const path = v['Vulnerable Path'];
    if (path && path !== 'N/A' && path !== '—') {
        document.getElementById('vPaths').innerHTML = path.split(',').map(p => `<div style="padding:2px 0">${p.trim()}</div>`).join('');
        document.getElementById('pathsCard').style.display = 'block';
    }

    // Remediation
    if (v.Remediation && v.Remediation !== 'N/A') {
        document.getElementById('vRemediation').textContent = v.Remediation;
        document.getElementById('remCard').style.display = 'block';
    }

    // Resolution Steps
    if (v['Resolution Steps'] && v['Resolution Steps'] !== 'N/A') {
        const steps = v['Resolution Steps'];
        let html = '';
        if (steps.includes('\n')) {
            const arr = steps.split('\n').filter(s => s.trim());
            html = arr.map((s, i) => `
                <div class="rem-step">
                    <div class="rem-num">${i+1}</div>
                    <p style="font-size:.875rem;color:var(--text);line-height:1.6">${s.trim()}</p>
                </div>`).join('');
        } else {
            html = `<div class="rem-step"><div class="rem-num">1</div><p style="font-size:.875rem;color:var(--text);line-height:1.6">${steps}</p></div>`;
        }
        document.getElementById('vSteps').innerHTML = html;
        document.getElementById('stepsCard').style.display = 'block';
    }

    // Detail table
    document.getElementById('detailTable').innerHTML = [
        ['Test',         v.Test || '—'],
        ['Severity',     sev],
        ['Status',       dispStatus],
        ['Target URL',   v.target_url || '—'],
        ['Scan Date',    date],
        ['Vulnerable Path', path || '—'],
    ].map(([k, val]) => `
        <tr>
            <td style="color:var(--text-muted);padding:.3rem 0;width:140px">${k}</td>
            <td style="font-weight:600;font-size:.825rem">${val}</td>
        </tr>`).join('');
}

function updateFixButton() {
    const btn = document.getElementById('fixBtn');
    if (!btn) return;
    const dispStatus = currentVuln ? (currentVuln._display_status || currentVuln.Status || '') : '';
    const isActionable = ['vulnerable'].includes((currentVuln?.Status||'').toLowerCase());

    if (!isActionable) {
        btn.style.display = 'none';
        return;
    }
    btn.style.display = 'inline-flex';
    if (isFixed) {
        btn.innerHTML   = '<i class="fa-solid fa-rotate-left"></i> Mark as Open';
        btn.className   = 'btn btn-o';
    } else {
        btn.innerHTML   = '<i class="fa-solid fa-circle-check"></i> Mark as Fixed';
        btn.className   = 'btn btn-p';
    }
}

async function toggleFix() {
    if (!currentVuln) return;
    const btn = document.getElementById('fixBtn');
    btn.disabled = true;
    try {
        const res  = await fetch(`/api/vulnerabilities/${vulnId}/fix`, { method:'POST' });
        const data = await res.json();
        if (data.status === 'success') {
            isFixed    = data.fixed;
            const newSt= data.new_status;
            // Update badge
            document.getElementById('statusBadge').className   = `bx ${statusClass(newSt)}`;
            document.getElementById('statusBadge').innerHTML   = `<i class="fa-solid fa-circle-${isFixed?'check':'exclamation'}"></i> ${newSt}`;
            // Update meta
            const ms = document.getElementById('metaStatus');
            if (ms) ms.textContent = newSt;
            // Update local state
            currentVuln._fixed          = isFixed;
            currentVuln._display_status = newSt;
            updateFixButton();
        }
    } catch (e) { console.error(e); }
    btn.disabled = false;
}

loadVuln();
// Poll every 8s in case status changes from another tab
setInterval(loadVuln, 8000);
</script>
{% endblock %}