{% extends "base.html" %}
{% block title %}Target View - VAPT Scanner Pro{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='css/targets.css') }}">
<style>
/* ── Severity & status badge colours ── */
.bx.bc  { background:#fff1f2; color:#be123c; border:1.5px solid #fda4af; }
.bx.bh  { background:#fff7ed; color:#c2410c; border:1.5px solid #fdba74; }
.bx.bm  { background:#fefce8; color:#a16207; border:1.5px solid #fde047; }
.bx.bl  { background:#f0fdf4; color:#16a34a; border:1.5px solid #86efac; }
.bx.bi  { background:#eff6ff; color:#2563eb; border:1.5px solid #93c5fd; }
.bx.bac { background:#f0fdf4; color:#15803d; border:1.5px solid #86efac; }
.bx.bop { background:#fef2f2; color:#b91c1c; border:1.5px solid #fca5a5; }
.bx.bcp { background:#f0fdf4; color:#15803d; border:1.5px solid #86efac; }  /* Completed — green */
.bx.bpd { background:#fefce8; color:#a16207; border:1.5px solid #fde047; }  /* Pending   — amber */
.bx.bsc { background:#eff6ff; color:#1d4ed8; border:1.5px solid #93c5fd; }  /* Scanning  — blue  */
.bx.bwb { background:#eff6ff; color:#1d4ed8; border:1.5px solid #93c5fd; }  /* Web type  */
.bx.bap { background:#faf5ff; color:#7c3aed; border:1.5px solid #c4b5fd; }  /* API type  */
.bx.bip { background:#f0fdf4; color:#15803d; border:1.5px solid #86efac; }  /* IP  type  */

/* ── Scan History ── */
.scan-hist-row {
  display: grid;
  grid-template-columns: 2.5rem 1fr auto auto auto auto auto auto auto auto;
  align-items: center;
  gap: .4rem;
  padding: .65rem .875rem;
  border-bottom: 1px solid var(--border);
  font-size: .78rem;
  cursor: pointer;
  user-select: none;
}
.scan-hist-row.active { background: #eff6ff; border-left: 3px solid var(--blue); }
.scan-hist-row:not(.active):hover .scan-chevron { color: var(--blue); }
.scan-hist-row:last-of-type { border-bottom: none; }
.scan-num { font-weight: 700; color: var(--text-muted); text-align: center; }
.scan-time-label { color: var(--text); font-weight: 600; }
.scan-latest-badge { display:inline-flex;align-items:center;gap:.25rem;padding:.15rem .5rem;background:#eff6ff;color:#2563eb;border:1px solid #93c5fd;border-radius:5px;font-size:.68rem;font-weight:700; }
.scan-chevron { color: var(--text-muted); font-size: .72rem; transition: transform .25s; }
.scan-chevron.open { transform: rotate(180deg); }

/* ── Expandable detail panel ── */
.scan-detail-panel {
  display: none;
  background: #f8fafc;
  border-bottom: 1px solid var(--border);
  border-left: 3px solid var(--blue);
  padding: .875rem 1rem .875rem 1.25rem;
  animation: slideDown .2s ease-out;
}
.scan-detail-panel.open { display: block; }
@keyframes slideDown { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

.scan-detail-grid {
  display: grid;
  grid-template-columns: repeat(6,1fr);
  gap: .5rem;
  margin-bottom: .75rem;
}
.sd-cell {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: .5rem .625rem;
  text-align: center;
}
.sd-cell small { display: block; font-size: .65rem; color: var(--text-muted); margin-bottom: .15rem; text-transform: uppercase; letter-spacing: .04em; }
.sd-cell strong { font-size: 1.1rem; font-weight: 700; }

/* Progress bar in detail panel */
.sd-prog-row { display:flex;align-items:center;gap:.5rem;margin-bottom:.3rem;font-size:.72rem; }
.sd-prog-lbl { width: 55px; color: var(--text-muted); font-weight: 600; }
.sd-prog-bar { flex:1; background:#e2e8f0; border-radius:6px; height:7px; overflow:hidden; }
.sd-prog-fill { height:100%; border-radius:6px; transition:width .6s ease; }
.sd-prog-pct { width:36px; text-align:right; font-weight:700; color:var(--text-muted); }

/* Success / vuln rate */
.sd-rates { display:flex; gap:1rem; margin-top:.5rem; flex-wrap:wrap; }
.sd-rate-item { display:flex; align-items:center; gap:.35rem; font-size:.75rem; font-weight:600; }
.sd-rate-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }

/* No data */
.no-data { text-align:center;padding:2rem;color:var(--text-muted);font-size:.825rem; }

/* vuln-sum */
.vuln-sum { display:grid; grid-template-columns:repeat(5,1fr); gap:.75rem; }

/* Live update dot */
.live-update { display:inline-flex;align-items:center;gap:.35rem;font-size:.72rem;color:var(--text-muted);font-weight:600; }
.live-update .dot { width:8px;height:8px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 0 rgba(34,197,94,.4);animation:livepulse 1.8s infinite; }
@keyframes livepulse { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4);} 50%{box-shadow:0 0 0 6px rgba(34,197,94,0);} }
</style>
{% endblock %}
{% block body %}
<div id="_main">
<div class="content">
  <a href="/targets" class="back-a"><i class="fa-solid fa-arrow-left"></i> Back to Targets</a>
  <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.625rem;">
    <div>
      <h1 style="font-family:'Space Grotesk',sans-serif;font-size:1.375rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:.4rem;">
        <i class="fa-solid fa-crosshairs" style="color:var(--blue)"></i><span id="tName">Loading…</span>
      </h1>
      <p id="tUrl" style="font-size:.78rem;color:var(--text-muted);">—</p>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;">
      <span class="live-update"><span class="dot"></span>Live Updates</span>
      <a href="/targets/{{ target_id }}/edit" class="btn btn-o"><i class="fa-regular fa-pen-to-square"></i> Edit</a>
      <a href="/scanning" class="btn btn-p"><i class="fa-solid fa-play"></i> Start Scan</a>
    </div>
  </div>

  <div class="meta-grid">
    <div class="meta-card"><small>Type</small><p id="mType">—</p></div>
    <div class="meta-card"><small>Status</small><p id="mStatus">—</p></div>
    <div class="meta-card"><small>Last Scan</small><p id="mLastScan" style="font-size:.82rem;font-weight:600;">—</p></div>
    <div class="meta-card"><small>Total Scans Run</small><h2 id="mScanCount" style="font-family:'Space Grotesk',sans-serif;font-size:1.75rem;font-weight:700;color:var(--blue);">0</h2></div>
  </div>

  <div class="card">
    <div class="ch"><i class="fa-solid fa-triangle-exclamation"></i> Vulnerability Summary <small style="font-weight:400;font-size:.72rem;margin-left:.5rem;color:rgba(255,255,255,.8)">latest scan</small></div>
    <div class="cb">
      <div class="vuln-sum" style="grid-template-columns:repeat(6,1fr);">
        <div class="vs"><strong id="vc-crit" style="color:#be123c">0</strong><small>Critical</small></div>
        <div class="vs"><strong id="vc-high" style="color:#c2410c">0</strong><small>High</small></div>
        <div class="vs"><strong id="vc-med"  style="color:#a16207">0</strong><small>Medium</small></div>
        <div class="vs"><strong id="vc-low"  style="color:#16a34a">0</strong><small>Low</small></div>
        <div class="vs"><strong id="vc-info" style="color:#2563eb">0</strong><small>Info</small></div>
        <div class="vs"><strong id="vc-total" style="color:var(--blue)">0</strong><small>Total</small></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ch"><i class="fa-solid fa-shield-halved"></i> Target Details</div>
    <div class="cb"><p id="tDesc" style="font-size:.875rem;color:var(--text-muted);">—</p></div>
  </div>

  <div class="card">
    <div class="ch"><i class="fa-solid fa-clock-rotate-left"></i> Scan History</div>
    <div id="scanHistoryBody">
      <div class="no-data"><i class="fa-solid fa-clock-rotate-left" style="font-size:1.5rem;display:block;margin-bottom:.4rem;color:var(--border)"></i>No scans yet.</div>
    </div>
  </div>

  <div class="card">
    <div class="ch"><i class="fa-solid fa-bug"></i> Recent Vulnerabilities <small style="font-weight:400;font-size:.72rem;margin-left:.5rem;color:rgba(255,255,255,.8)">latest 10</small></div>
    <div class="cb" style="padding:0;overflow-x:auto;">
      <table class="dt">
        <thead><tr><th>Vulnerability</th><th>Severity</th><th>Status</th><th>Path</th><th>Actions</th></tr></thead>
        <tbody id="vulnBody"><tr><td colspan="5" class="no-data">No data yet.</td></tr></tbody>
      </table>
    </div>
    <div style="padding:.75rem 1rem;text-align:right;border-top:1px solid var(--border);">
      <a href="/vulnerabilities" class="btn btn-o btn-s">View All <i class="fa-solid fa-arrow-right"></i></a>
    </div>
  </div>
</div></div>
{% endblock %}
{% block scripts %}
<script>
initLayout('/targets');
const TARGET_ID = {{ target_id }};

// ── Badge helpers ────────────────────────────────────────────
function sevBadge(s){
  s=(s||'').toLowerCase();
  const m={
    critical: ['bc','fa-triangle-exclamation','Critical'],
    high:     ['bh','fa-triangle-exclamation','High'],
    medium:   ['bm','fa-triangle-exclamation','Medium'],
    low:      ['bl','fa-shield-halved','Low'],
    info:     ['bi','fa-shield-halved','Info'],
  };
  const [c,i,l]=m[s]||['bi','fa-shield-halved',s||'Info'];
  return `<span class="bx ${c}"><i class="fa-solid ${i}"></i> ${l}</span>`;
}
function statusBadge(s){
  s=(s||'').toLowerCase();
  if(s==='vulnerable') return `<span class="bx bop"><i class="fa-solid fa-circle-exclamation"></i> Vulnerable</span>`;
  if(s==='fixed')      return `<span class="bx bac"><i class="fa-solid fa-circle-check"></i> Fixed</span>`;
  if(s==='secure')     return `<span class="bx bac"><i class="fa-solid fa-circle-check"></i> Secure</span>`;
  if(s==='complete')   return `<span class="bx bcp"><i class="fa-solid fa-circle-check"></i> Complete</span>`;
  return `<span class="bx" style="background:#f3f4f6;color:#374151;border:1px solid #d1d5db;">${s||'—'}</span>`;
}
function typeIcon(t){t=(t||'').toLowerCase();return t==='api'?'fa-code':t==='ip'?'fa-wifi':'fa-globe';}
function typeClass(t){t=(t||'').toLowerCase();return t==='api'?'bap':t==='ip'?'bip':'bwb';}
function fmtRuntime(sec){ if(!sec&&sec!==0) return '—'; if(sec<60) return sec+'s'; return Math.floor(sec/60)+'m '+(sec%60?sec%60+'s':''); }

// ── Track which panels are open (persists across refreshes) ──
const openPanels = new Set();
let lastHistHash = ''; // track if scan history data changed

// ── Toggle scan detail panel ─────────────────────────────────
function toggleScanPanel(idx) {
  const row   = document.getElementById('shr-'+idx);
  const panel = document.getElementById('shp-'+idx);
  const chev  = document.getElementById('shc-'+idx);
  if (!panel) return;
  const isOpen = panel.classList.contains('open');
  if (isOpen) {
    panel.classList.remove('open');
    row.classList.remove('active');
    chev.classList.remove('open');
    openPanels.delete(idx);
  } else {
    panel.classList.add('open');
    row.classList.add('active');
    chev.classList.add('open');
    openPanels.add(idx);
  }
}

// ── Render scan history (only re-renders when data changes) ──
function renderScanHistory(hist) {
  const histEl = document.getElementById('scanHistoryBody');
  if (!hist || !hist.length) {
    histEl.innerHTML = `<div class="no-data"><i class="fa-solid fa-clock-rotate-left" style="font-size:1.5rem;display:block;margin-bottom:.4rem;color:var(--border)"></i>No scans run yet for this target.</div>`;
    lastHistHash = '';
    return;
  }

  // Only re-render DOM if data actually changed — prevents blink on every poll
  const newHash = JSON.stringify(hist.map(h => [h.scan_time||h.date, h.total, h.critical, h.high, h.medium, h.low, h.info, h.runtime_seconds]));
  if (newHash === lastHistHash) {
    // Data unchanged — just update open state classes without touching DOM structure
    return;
  }
  lastHistHash = newHash;

  histEl.innerHTML = hist.map((h, i) => {
    const num     = hist.length - i;
    const total   = h.total || 0;
    const crit    = h.critical || 0;
    const high    = h.high     || 0;
    const med     = h.medium   || 0;
    const low     = h.low      || 0;
    const info    = h.info     != null ? h.info : Math.max(0, total - crit - high - med - low);
    const safeN   = med + low + info;
    const succPct = total > 0 ? Math.round(safeN / total * 100) : 100;
    const vulnPct = total > 0 ? Math.round((crit + high) / total * 100) : 0;
    const rt      = fmtRuntime(h.runtime_seconds);
    const sColor  = succPct >= 80 ? '#22c55e' : succPct >= 50 ? '#eab308' : '#ef4444';
    const vColor  = vulnPct <= 10 ? '#22c55e' : vulnPct <= 30 ? '#eab308' : '#ef4444';
    const pct     = (n) => total > 0 ? Math.round(n / total * 100) : 0;

    // Restore open state from saved set
    const wasOpen = openPanels.has(i);

    return `
      <div class="scan-hist-row ${wasOpen ? 'active' : ''}" id="shr-${i}" onclick="toggleScanPanel(${i})">
        <span class="scan-num">#${num}</span>
        <span class="scan-time-label">
          <i class="fa-regular fa-clock" style="color:var(--text-muted);margin-right:.3rem;"></i>${h.scan_time || h.date || '—'}
        </span>
        ${i === 0 ? '<span class="scan-latest-badge"><i class="fa-solid fa-star"></i> Latest</span>' : '<span></span>'}
        <span class="bx bc" style="min-width:2.5rem;justify-content:center;font-size:.7rem;">${crit}C</span>
        <span class="bx bh" style="min-width:2.5rem;justify-content:center;font-size:.7rem;">${high}H</span>
        <span class="bx bm" style="min-width:2.5rem;justify-content:center;font-size:.7rem;">${med}M</span>
        <span class="bx bl" style="min-width:2.5rem;justify-content:center;font-size:.7rem;">${low}L</span>
        <span class="bx bi" style="min-width:2.5rem;justify-content:center;font-size:.7rem;">${info}I</span>
        <span style="font-size:.74rem;color:var(--text-muted);">${total} total</span>
        <i class="fa-solid fa-chevron-down scan-chevron ${wasOpen ? 'open' : ''}" id="shc-${i}"></i>
      </div>

      <div class="scan-detail-panel ${wasOpen ? 'open' : ''}" id="shp-${i}">
        <div class="scan-detail-grid" style="grid-template-columns:repeat(4,1fr);">
          <div class="sd-cell"><small>Date / Time</small><strong style="font-size:.82rem;font-weight:600;">${h.scan_time || h.date || '—'}</strong></div>
          <div class="sd-cell"><small>Runtime</small><strong style="color:var(--blue);">${rt}</strong></div>
          <div class="sd-cell"><small>Total</small><strong style="color:var(--text);">${total}</strong></div>
          <div class="sd-cell"><small>Critical</small><strong style="color:#ef4444;">${crit}</strong></div>
          <div class="sd-cell"><small>High</small><strong style="color:#f97316;">${high}</strong></div>
          <div class="sd-cell"><small>Medium</small><strong style="color:#eab308;">${med}</strong></div>
          <div class="sd-cell"><small>Low</small><strong style="color:#22c55e;">${low}</strong></div>
          <div class="sd-cell"><small>Info</small><strong style="color:#2563eb;">${info}</strong></div>
        </div>
        <div style="background:#fff;border:1px solid var(--border);border-radius:9px;padding:.75rem 1rem;margin-bottom:.625rem;">
          <p style="font-size:.72rem;font-weight:700;color:var(--text);margin-bottom:.5rem;"><i class="fa-solid fa-bars-progress" style="color:var(--blue);margin-right:.3rem;"></i>Severity Breakdown</p>
          <div class="sd-prog-row"><span class="sd-prog-lbl" style="color:#ef4444;">Critical</span><div class="sd-prog-bar"><div class="sd-prog-fill" style="width:${pct(crit)}%;background:#ef4444;"></div></div><span class="sd-prog-pct">${pct(crit)}%</span></div>
          <div class="sd-prog-row"><span class="sd-prog-lbl" style="color:#f97316;">High</span><div class="sd-prog-bar"><div class="sd-prog-fill" style="width:${pct(high)}%;background:#f97316;"></div></div><span class="sd-prog-pct">${pct(high)}%</span></div>
          <div class="sd-prog-row"><span class="sd-prog-lbl" style="color:#eab308;">Medium</span><div class="sd-prog-bar"><div class="sd-prog-fill" style="width:${pct(med)}%;background:#eab308;"></div></div><span class="sd-prog-pct">${pct(med)}%</span></div>
          <div class="sd-prog-row"><span class="sd-prog-lbl" style="color:#22c55e;">Low</span><div class="sd-prog-bar"><div class="sd-prog-fill" style="width:${pct(low)}%;background:#22c55e;"></div></div><span class="sd-prog-pct">${pct(low)}%</span></div>
          <div class="sd-prog-row"><span class="sd-prog-lbl" style="color:#2563eb;">Info</span><div class="sd-prog-bar"><div class="sd-prog-fill" style="width:${pct(info)}%;background:#2563eb;"></div></div><span class="sd-prog-pct">${pct(info)}%</span></div>
        </div>
        <div class="sd-rates">
          <div class="sd-rate-item">
            <span class="sd-rate-dot" style="background:${sColor};"></span>
            <span style="color:var(--text-muted);">Success Rate:</span>
            <span style="color:${sColor};font-size:.9rem;">${succPct}%</span>
            <span style="font-size:.68rem;color:var(--text-muted);">(non-critical findings)</span>
          </div>
          <div class="sd-rate-item">
            <span class="sd-rate-dot" style="background:${vColor};"></span>
            <span style="color:var(--text-muted);">Vuln Rate:</span>
            <span style="color:${vColor};font-size:.9rem;">${vulnPct}%</span>
            <span style="font-size:.68rem;color:var(--text-muted);">(critical + high)</span>
          </div>
          ${h.report ? `<a href="/reports" class="btn btn-o btn-s" style="margin-left:auto;"><i class="fa-regular fa-file-lines"></i> View Report</a>` : ''}
        </div>
      </div>`;
  }).join('');
}

// ── Status badge — Completed / Scanning / Pending ────────────
function getStatusBadge(t) {
  const scanStatus = (t.scan_status || '').toLowerCase();
  const rawStatus  = (t.status || '').toLowerCase();
  if (scanStatus === 'running' || scanStatus === 'scanning') {
    return `<span class="bx bsc"><i class="fa-solid fa-spinner fa-spin"></i> Scanning</span>`;
  }
  if (scanStatus === 'completed' || rawStatus === 'completed' || (t.last_scan && t.last_scan !== 'Never')) {
    return `<span class="bx bcp"><i class="fa-solid fa-circle-check"></i> Completed</span>`;
  }
  return `<span class="bx bpd"><i class="fa-solid fa-clock"></i> Pending</span>`;
}

// ── Severity order for sorting ───────────────────────────────
const SEV_ORDER = {critical:0, high:1, medium:2, low:3, info:4};

let lastVulnHash = '';

// ── Main load ────────────────────────────────────────────────
async function loadTarget(){
  try{
    const res  = await fetch(`/api/targets/${TARGET_ID}`);
    const data = await res.json();
    if(data.status !== 'ok') return;
    const t = data.target;

    document.getElementById('tName').textContent = t.name || '—';
    document.getElementById('tUrl').textContent  = t.url  || '—';

    // Target Details — auto-generated description + latest indicators
    const vc   = t.vuln_counts || {};
    const desc = t.description && t.description.trim() !== '' && t.description !== 'No description provided.' ? t.description : null;
    const isLatestScan = t.last_scan && t.last_scan !== 'Never';
    const host = (t.url||'').replace(/https?:\/\//,'').split('/')[0];
    const typeStr  = (t.type||'Web').toLowerCase();
    const scans    = t.scan_count || 0;
    const total    = t.total_vulns || 0;
    const critical = vc.critical || 0;
    const high     = vc.high || 0;
    const riskStr  = critical > 0 ? '<span style="color:#be123c;font-weight:700;">critical risk</span>'
                   : high     > 0 ? '<span style="color:#c2410c;font-weight:700;">elevated risk</span>'
                   : '<span style="color:#15803d;font-weight:700;">low risk</span>';

    const autoDesc = desc
      ? `<span style="color:var(--text);">${desc}</span>`
      : scans === 0
        ? `<span style="color:var(--text);"><strong>${host}</strong> is a <strong>${typeStr}</strong> target registered for security scanning. No scans have been run yet. <a href="/scanning" style="color:var(--blue);">Start a scan</a> to begin assessing vulnerabilities.</span>`
        : `<span style="color:var(--text);"><strong>${host}</strong> is a <strong>${typeStr}</strong> target scanned <strong>${scans} time${scans!==1?'s':''}</strong>. The latest scan on <strong>${t.last_scan}</strong> identified <strong>${total} total findings</strong> with ${riskStr} profile — <span style="color:#be123c;font-weight:600;">${critical} critical</span>, <span style="color:#c2410c;font-weight:600;">${high} high</span>, <span style="color:#a16207;font-weight:600;">${vc.medium||0} medium</span>, <span style="color:#15803d;font-weight:600;">${vc.low||0} low</span>, and <span style="color:#1d4ed8;font-weight:600;">${vc.info||0} informational</span>.</span>`;

    document.getElementById('tDesc').innerHTML = `
      <table style="width:100%;font-size:.845rem;border-collapse:collapse;">
        <tr>
          <td style="color:var(--text-muted);padding:.4rem 0;width:150px;vertical-align:top;font-weight:500;">Description</td>
          <td style="padding:.4rem 0;line-height:1.7;">${autoDesc}</td>
        </tr>
        <tr style="border-top:1px solid var(--border);">
          <td style="color:var(--text-muted);padding:.4rem 0;font-weight:500;">URL</td>
          <td style="padding:.4rem 0;"><a href="${t.url||'#'}" target="_blank" style="color:var(--blue);text-decoration:none;font-weight:600;">${t.url||'—'}</a></td>
        </tr>
        <tr style="border-top:1px solid var(--border);">
          <td style="color:var(--text-muted);padding:.4rem 0;font-weight:500;">Type</td>
          <td style="padding:.4rem 0;">${(() => { const tc=typeClass(t.type),ti=typeIcon(t.type); return `<span class="bx ${tc}"><i class="fa-solid ${ti}"></i> ${t.type||'Web'}</span>`; })()}</td>
        </tr>
        <tr style="border-top:1px solid var(--border);">
          <td style="color:var(--text-muted);padding:.4rem 0;font-weight:500;">Last Scan</td>
          <td style="padding:.4rem 0;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
            <span style="font-weight:600;">${t.last_scan||'Never'}</span>
            ${isLatestScan ? `<span style="display:inline-flex;align-items:center;gap:.2rem;padding:.12rem .45rem;background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd;border-radius:5px;font-size:.65rem;font-weight:700;"><i class="fa-solid fa-star" style="font-size:.55rem;"></i> Latest</span>` : ''}
          </td>
        </tr>
        <tr style="border-top:1px solid var(--border);">
          <td style="color:var(--text-muted);padding:.4rem 0;font-weight:500;">Total Scans</td>
          <td style="font-weight:600;padding:.4rem 0;">${scans}</td>
        </tr>
        <tr style="border-top:1px solid var(--border);">
          <td style="color:var(--text-muted);padding:.4rem 0;font-weight:500;">Total Findings</td>
          <td style="padding:.4rem 0;">
            <span style="font-weight:700;font-size:.95rem;">${total}</span>
            <span style="margin-left:.5rem;font-size:.72rem;">
              ${critical ? `<span style="color:#be123c;font-weight:700;margin-right:.3rem;">${critical}C</span>` : ''}
              ${high     ? `<span style="color:#c2410c;font-weight:700;margin-right:.3rem;">${high}H</span>` : ''}
              ${vc.medium ? `<span style="color:#a16207;font-weight:700;margin-right:.3rem;">${vc.medium}M</span>` : ''}
              ${vc.low    ? `<span style="color:#15803d;font-weight:700;margin-right:.3rem;">${vc.low}L</span>` : ''}
              ${vc.info   ? `<span style="color:#1d4ed8;font-weight:700;">${vc.info}I</span>` : ''}
            </span>
          </td>
        </tr>
        <tr style="border-top:1px solid var(--border);">
          <td style="color:var(--text-muted);padding:.4rem 0;font-weight:500;">Scan Status</td>
          <td style="padding:.4rem 0;">${getStatusBadge(t)}</td>
        </tr>
      </table>`;

    const tc = typeClass(t.type), ti = typeIcon(t.type);
    document.getElementById('mType').innerHTML = `<span class="bx ${tc}"><i class="fa-solid ${ti}"></i> ${t.type||'Web'}</span>`;

    // Status — Completed if scanned, Pending if never scanned, Scanning if running
    document.getElementById('mStatus').innerHTML = getStatusBadge(t);
    document.getElementById('mLastScan').textContent  = t.last_scan  || 'Never';
    document.getElementById('mScanCount').textContent = t.scan_count || 0;

    document.getElementById('vc-crit').textContent  = vc.critical || 0;
    document.getElementById('vc-high').textContent  = vc.high     || 0;
    document.getElementById('vc-med').textContent   = vc.medium   || 0;
    document.getElementById('vc-low').textContent   = vc.low      || 0;
    document.getElementById('vc-info').textContent  = vc.info     || 0;
    document.getElementById('vc-total').textContent = t.total_vulns || 0;

    // Scan history — clickable rows
    renderScanHistory(t.scan_history || []);

    // Recent vulns — sorted by severity: Critical → High → Medium → Low → Info
    const vulns = (t.recent_vulns || []).sort((a, b) => {
      const sa = SEV_ORDER[(a.severity||'info').toLowerCase()] ?? 4;
      const sb = SEV_ORDER[(b.severity||'info').toLowerCase()] ?? 4;
      return sa - sb;
    });

    // Only re-render vulns if data changed
    const newVulnHash = JSON.stringify(vulns.map(v => [v.test, v.severity, v.status, v.path]));
    if (newVulnHash !== lastVulnHash) {
      lastVulnHash = newVulnHash;
      const tbody = document.getElementById('vulnBody');
      if(!vulns.length){
        tbody.innerHTML = `<tr><td colspan="5" class="no-data" style="padding:1.5rem;">No vulnerabilities recorded yet.</td></tr>`;
      } else {
        tbody.innerHTML = vulns.map(v => {
          const hasPath = v.path && v.path !== 'N/A' && v.path !== '—' && v.path.trim() !== '';
          const displayPath = hasPath ? v.path : (t.url || '—');
          const shortPath = displayPath.replace(/https?:\/\//, '');
          const pathColor = hasPath ? 'var(--blue)' : 'var(--text-muted)';
          return `
          <tr>
            <td><strong>${v.test}</strong><br><small style="color:var(--text-muted);">${(v.finding||'').slice(0,90)}${v.finding&&v.finding.length>90?'…':''}</small></td>
            <td>${sevBadge(v.severity)}</td>
            <td>${statusBadge(v.status)}</td>
            <td>
              <span style="display:inline-flex;align-items:center;gap:.25rem;font-size:.74rem;color:${pathColor};max-width:200px;">
                <i class="fa-solid fa-link" style="font-size:.6rem;flex-shrink:0;color:var(--border);"></i>
                <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${displayPath}">${shortPath}</span>
              </span>
            </td>
            <td><a href="/vulnerabilities" class="btn btn-o btn-s"><i class="fa-regular fa-eye"></i></a></td>
          </tr>`}).join('');
      }
    }
  } catch(e){ console.error('loadTarget error:', e); }
}

loadTarget();
setInterval(loadTarget, 5000); // live updates every 5s
</script>
{% endblock %}